{%- liquid
  assign section_st = section.settings
  assign target_hour = section_st.target_hour
  assign target_minute = section_st.target_minute
  assign show_hours = section_st.show_hours
  assign show_minutes = section_st.show_minutes
  assign show_seconds = section_st.show_seconds
  assign bg_color = section_st.bg_color
  assign text_color = section_st.text_color
  assign digit_bg_color = section_st.digit_bg_color
  assign digit_text_color = section_st.digit_text_color
  assign heading_text = section_st.heading_text
  assign heading_font_size = section_st.heading_font_size
  assign label_hours = section_st.label_hours
  assign label_minutes = section_st.label_minutes
  assign label_seconds = section_st.label_seconds
  assign timer_size = section_st.timer_size
  assign border_radius = section_st.border_radius
  if section_st.reset_spacing
    assign reset_spacing = ' remove_spacing'
  endif
-%}

{%- capture style -%}
  --section-pt: {{ section_st.padding_top }}; --section-pb: {{ section_st.padding_bottom }};
{%- endcapture -%}

<style>
  .countdown-timer-section {
    background-color: {{ bg_color }};
    color: {{ text_color }};
    text-align: center;
  }

  .countdown-timer__heading {
    margin: 0 0 16px 0;
    font-size: {{ heading_font_size }}px;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: {{ text_color }};
    line-height: 1.2;
  }

  .countdown-timer__wrap {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .countdown-timer__block {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }

  .countdown-timer__digits {
    display: flex;
    gap: 4px;
  }

  .countdown-timer__digit {
    background-color: {{ digit_bg_color }};
    color: {{ digit_text_color }};
    font-size: {{ timer_size }}px;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
    min-width: calc({{ timer_size }}px * 0.75);
    height: calc({{ timer_size }}px * 1.3);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: {{ border_radius }}px;
    line-height: 1;
    font-family: inherit;
  }

  .countdown-timer__label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: {{ text_color }};
    opacity: 0.8;
  }

  .countdown-timer__separator {
    font-size: {{ timer_size }}px;
    font-weight: 700;
    color: {{ digit_text_color }};
    line-height: 1;
    padding-bottom: 22px;
    opacity: 0.6;
  }

  .countdown-timer__expired {
    font-size: 16px;
    font-weight: 600;
    padding: 10px 0;
    opacity: 0.7;
  }

  @media (max-width: 749px) {
    .countdown-timer__heading {
      font-size: {{ heading_font_size | minus: 4 }}px;
    }
    .countdown-timer__digit {
      font-size: {{ timer_size | minus: 8 }}px;
      min-width: calc(({{ timer_size }}px - 8px) * 0.75);
      height: calc(({{ timer_size }}px - 8px) * 1.3);
    }
    .countdown-timer__separator {
      font-size: {{ timer_size | minus: 8 }}px;
    }
  }
</style>

<div
  class="section countdown-timer-section{% if section_st.padding_top < 30 %} pt-min{% endif %}{% if section_st.padding_bottom < 30 %} pb-min{% endif %}{{ reset_spacing }}"
  style="{{ style | strip | strip_newlines }}"
>
  <div class="container">
    {%- if heading_text != blank -%}
      <p class="countdown-timer__heading">{{ heading_text }}</p>
    {%- endif -%}

    <div
      class="countdown-timer__wrap"
      id="countdown-timer-{{ section.id }}"
      data-target-hour="{{ target_hour }}"
      data-target-minute="{{ target_minute }}"
      data-show-hours="{{ show_hours }}"
      data-show-minutes="{{ show_minutes }}"
      data-show-seconds="{{ show_seconds }}"
      data-label-hours="{{ label_hours }}"
      data-label-minutes="{{ label_minutes }}"
      data-label-seconds="{{ label_seconds }}"
    >
      {%- comment -%} Rendered by JS {%- endcomment -%}
      <div class="countdown-timer__expired" style="display:none;">Tempo esgotado</div>
    </div>
  </div>
</div>

<script>
  (function () {
    const wrapper = document.getElementById('countdown-timer-{{ section.id }}');
    if (!wrapper) return;

    const targetHour = parseInt(wrapper.dataset.targetHour, 10);
    const targetMinute = parseInt(wrapper.dataset.targetMinute, 10);
    const showHours = wrapper.dataset.showHours === 'true';
    const showMinutes = wrapper.dataset.showMinutes === 'true';
    const showSeconds = wrapper.dataset.showSeconds === 'true';
    const labelHours = wrapper.dataset.labelHours || 'Horas';
    const labelMinutes = wrapper.dataset.labelMinutes || 'Minutos';
    const labelSeconds = wrapper.dataset.labelSeconds || 'Segundos';

    const expiredEl = wrapper.querySelector('.countdown-timer__expired');

    function getTargetDate() {
      const now = new Date();
      const target = new Date(now);
      target.setHours(targetHour, targetMinute, 0, 0);
      if (target <= now) {
        target.setDate(target.getDate() + 1);
      }
      return target;
    }

    function padDigit(num, length) {
      return String(num).padStart(length, '0');
    }

    function createBlock(value, label, digitCount) {
      const digits = padDigit(value, digitCount);
      let html = '<div class="countdown-timer__block">';
      html += '<div class="countdown-timer__digits">';
      for (let i = 0; i < digits.length; i++) {
        html += '<span class="countdown-timer__digit">' + digits[i] + '</span>';
      }
      html += '</div>';
      html += '<span class="countdown-timer__label">' + label + '</span>';
      html += '</div>';
      return html;
    }

    function render() {
      const now = new Date();
      const target = getTargetDate();
      let diff = Math.max(0, Math.floor((target - now) / 1000));

      if (diff <= 0) {
        expiredEl.style.display = 'block';
        clearExistingBlocks();
        return;
      }

      expiredEl.style.display = 'none';

      const hours = Math.floor(diff / 3600);
      diff %= 3600;
      const minutes = Math.floor(diff / 60);
      const seconds = diff % 60;

      let html = '';

      if (showHours) {
        html += createBlock(hours, labelHours, 2);
        if (showMinutes || showSeconds) {
          html += '<span class="countdown-timer__separator">:</span>';
        }
      }

      if (showMinutes) {
        html += createBlock(showHours ? minutes : Math.floor(hours * 60 + minutes), labelMinutes, 2);
        if (showSeconds) {
          html += '<span class="countdown-timer__separator">:</span>';
        }
      }

      if (showSeconds) {
        html += createBlock(seconds, labelSeconds, 2);
      }

      // Only update the DOM content (blocks + separators), keep the expired element
      const existingBlocks = wrapper.querySelectorAll('.countdown-timer__block, .countdown-timer__separator');
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      const newNodes = Array.from(tempDiv.children);

      // Compare existing vs new content
      if (existingBlocks.length === 0) {
        // First render
        newNodes.forEach((node) => wrapper.insertBefore(node, expiredEl));
      } else {
        // Update digit values only for performance
        const currentDigits = wrapper.querySelectorAll('.countdown-timer__digit');
        const allDigitValues = [];
        if (showHours) {
          const h = padDigit(hours, 2);
          allDigitValues.push(h[0], h[1]);
        }
        if (showMinutes) {
          const m = padDigit(showHours ? minutes : Math.floor(hours * 60 + minutes), 2);
          allDigitValues.push(m[0], m[1]);
        }
        if (showSeconds) {
          const s = padDigit(seconds, 2);
          allDigitValues.push(s[0], s[1]);
        }

        currentDigits.forEach((digit, i) => {
          if (allDigitValues[i] !== undefined && digit.textContent !== allDigitValues[i]) {
            digit.textContent = allDigitValues[i];
          }
        });
      }
    }

    function clearExistingBlocks() {
      const blocks = wrapper.querySelectorAll('.countdown-timer__block, .countdown-timer__separator');
      blocks.forEach((b) => b.remove());
    }

    render();
    setInterval(render, 1000);
  })();
</script>

{% schema %}
{
  "name": "Countdown Timer",
  "tag": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading_text",
      "label": "Texto acima do timer",
      "default": "LANÇAMENTO RAPTORX"
    },
    {
      "type": "range",
      "id": "heading_font_size",
      "label": "Tamanho do texto (título)",
      "default": 22,
      "min": 12,
      "max": 48,
      "step": 1,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Horário alvo"
    },
    {
      "type": "range",
      "id": "target_hour",
      "label": "Hora (0–23)",
      "default": 23,
      "min": 0,
      "max": 23,
      "step": 1
    },
    {
      "type": "range",
      "id": "target_minute",
      "label": "Minuto (0–59)",
      "default": 59,
      "min": 0,
      "max": 59,
      "step": 1
    },
    {
      "type": "header",
      "content": "Exibição"
    },
    {
      "type": "checkbox",
      "id": "show_hours",
      "label": "Mostrar horas",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_minutes",
      "label": "Mostrar minutos",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_seconds",
      "label": "Mostrar segundos",
      "default": true
    },
    {
      "type": "header",
      "content": "Rótulos"
    },
    {
      "type": "text",
      "id": "label_hours",
      "label": "Rótulo horas",
      "default": "Horas"
    },
    {
      "type": "text",
      "id": "label_minutes",
      "label": "Rótulo minutos",
      "default": "Minutos"
    },
    {
      "type": "text",
      "id": "label_seconds",
      "label": "Rótulo segundos",
      "default": "Segundos"
    },
    {
      "type": "header",
      "content": "Tamanho do timer"
    },
    {
      "type": "range",
      "id": "timer_size",
      "label": "Tamanho dos dígitos",
      "default": 36,
      "min": 20,
      "max": 72,
      "step": 2,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Arredondamento dos dígitos",
      "default": 6,
      "min": 0,
      "max": 20,
      "step": 1,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Cores"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Cor de fundo da seção",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Cor dos textos",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "digit_bg_color",
      "label": "Cor de fundo dos dígitos",
      "default": "#2a2a2a"
    },
    {
      "type": "color",
      "id": "digit_text_color",
      "label": "Cor dos dígitos",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Espaçamento"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Espaço superior",
      "default": 30,
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Espaço inferior",
      "default": 30,
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px"
    },
    {
      "type": "checkbox",
      "id": "reset_spacing",
      "label": "Remover espaçamento",
      "default": false
    }
  ],
  "presets": [
    {
      "name": "Countdown Timer"
    }
  ]
}
{% endschema %}
